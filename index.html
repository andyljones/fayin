<html>
<head>
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>
<script>

PUNC = ' ，!"%,-./:;?[]°·—‘’“”…℃─\u3000、。《》【】'

SENTENCES = [{
    "hanzi": "很好，谢谢。",
    "pinyin": "nǐ hǎo",
    "english": "Hello",
    "hsk": 1, "limit": 1, "part": 1}];

TARGET = "Initial target";
TRANSCRIPT = "Initial transcript";
FINALIZED = false;

function fetch_sentences(level) {
    $.getJSON('sentences-1.json', (data) => { 
        SENTENCES = data; 
    })
}

function update_text() {
    const is_finalized = FINALIZED? "finalized" : "unfinalized" 

    var target = [];
    var transcript = [];
    var target_idx = 0, trans_idx = 0;
    while (true) {
        if ((target_idx < TARGET.length) && (trans_idx < TRANSCRIPT.length)) {
            if (PUNC.includes(TARGET[target_idx])) {
                target.push($('<span/>').addClass('correct').html(TARGET[target_idx]));
                transcript.push($('<span/>').addClass('correct').html(TARGET[target_idx]));
                target_idx += 1;
            } else {
                var cls = TARGET[target_idx] == TRANSCRIPT[trans_idx]? 'correct' : 'error';
                target.push($('<span/>').addClass(cls).html(TARGET[target_idx]));
                transcript.push($('<span/>').addClass(cls).addClass(is_finalized).html(TRANSCRIPT[trans_idx]));
                target_idx += 1;
                trans_idx += 1;
            }
        } else if (target_idx < TARGET.length) {
            target.push($('<span/>').addClass('unseen').html(TARGET[target_idx]));
            target_idx += 1
        } else if (trans_idx < TRANSCRIPT.length) {
            transcript.push($('<span/>').addClass('error').addClass(is_finalized).html(TRANSCRIPT[trans_idx]));
            trans_idx += 1
        } else {
            break;
        }
    }

    $("#target").html(target);
    $("#transcript").html(transcript);
}

function pick_target() {
    const idx = Math.floor(Math.random() * SENTENCES.length)
    TARGET = SENTENCES[idx].hanzi;
    TRANSCRIPT = "";
    update_text();
}

function success() {
    if (!FINALIZED) {
        return false;
    }
    for (var i=0; i<TARGET.length; i++) {
    }
}

function handle_recognition(event) {
    var result = event.results[event.results.length-1]
    TRANSCRIPT = result[0].transcript;
    FINALIZED = result.isFinal;
    update_text()
    if (FINALIZED & (TARGET == TRANSCRIPT)) {
        pick_target();
    }
}

function start_recogniser() {
    var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
    var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;
    var SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent;

    var recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = "zh-CN";
    recognition.onresult = handle_recognition;

    recognition.start();
}

$(document).ready(() => {
    fetch_sentences();
    pick_target();
    start_recogniser();
});

</script>

<style>
    #contents {
        display: block; 
        margin: auto;
        width: 800px;
        border: 1px solid black;
        font-size: x-large;
    }

    #contents p {
        margin: 10px;
        height: 1.5em;
    }

    .correct {
        color: green;
    }

    .unfinalized {
        opacity: .5;
    }

    .finalized {
        opacity: 1.;
    }

    .error {
        color: red;
    }
</style>

</head>
<body>
    <div id="contents">
        <p id="target"> </p>
        <p id="transcript"> </p>
    </div>
</body>

</html>